# 📋 מדריך הגדרה - רשימת המתנה

## ✅ מה נוסף למערכת?

### 1. **הודעה על תורים תפוסים**
- כשלקוח בוחר יום ללא שעות פנויות, מוצגת הודעה: "נתפסו כל התורים!"

### 2. **רשימת המתנה - צד לקוח**
- מלבן אדום מתחת לבחירת שעות: "לא מצאת תור לזמן שלך? כנס לרשימת המתנה"
- מודל לבחירת טווח שעות מבוקש
- הודעת אישור לאחר הרשמה

### 3. **רשימת המתנה - צד אדמין**
- מסך חדש: "רשימת המתנה" בתפריט האדמין
- תצוגה של 7 ימים הקרובים
- פרטי כל לקוח: שם, טלפון, טווח שעות
- אפשרות למחוק רשומות

### 4. **הודעות אוטומטיות**
- ברגע שמישהו מבטל תור → הודעת פוש לכל מי שברשימת ההמתנה לאותו יום

### 5. **מחיקה אוטומטית**
- רשומות ישנות נמחקות אוטומטית כשעובר התאריך

---

## 🚀 שלבי הגדרה

### שלב 1: רענן את האפליקציה
```bash
# עצור את השרת הנוכחי (Ctrl+C)

# נקה את ה-cache
npx expo start -c

# או אם זה לא עובד:
npm start -- --reset-cache
```

### שלב 2: צור אינדקסים ב-Firestore

**חובה!** בלי זה הפיצ'ר לא יעבוד.

#### אופציה 1 (מומלץ): תן ל-Firebase ליצור אוטומטית
1. הרץ את האפליקציה
2. נסה להיכנס למסך "רשימת המתנה" באדמין
3. פתח את הקונסול (בדפדפן או ב-terminal)
4. תראה שגיאה עם **קישור ישיר** ליצירת אינדקס
5. לחץ על הקישור - Firebase תיצור את האינדקס אוטומטית

**דוגמה לשגיאה:**
```
Error: The query requires an index. You can create it here: https://console.firebase.google.com/...
```

#### אופציה 2: צור ידנית
1. כנס ל-Firebase Console: https://console.firebase.google.com
2. בחר את הפרויקט שלך
3. לך ל-**Firestore Database** → **Indexes**
4. לחץ על **Create Index**

**אינדקס 1:**
- Collection ID: `waitlist`
- Fields:
  - `barberId` - Ascending
  - `date` - Ascending
  - `createdAt` - Ascending

**אינדקס 2:**
- Collection ID: `waitlist`
- Fields:
  - `userId` - Ascending
  - `date` - Ascending

5. לחץ על **Create** ו**חכה 2-5 דקות** לבנייה

### שלב 3: הוסף חוקי אבטחה (Firestore Security Rules)

1. כנס ל-Firebase Console → Firestore Database → Rules
2. הוסף את הקוד הזה:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ... הכללים הקיימים שלך ...
    
    // חוקים חדשים לרשימת המתנה
    match /waitlist/{entryId} {
      // לקוחות יכולים ליצור רשומות משלהם
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      
      // לקוחות יכולים לקרוא את הרשומות שלהם, אדמינים יכולים לקרוא הכל
      allow read: if request.auth != null 
                  && (resource.data.userId == request.auth.uid 
                      || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true);
      
      // לקוחות ואדמינים יכולים למחוק
      allow delete: if request.auth != null 
                    && (resource.data.userId == request.auth.uid 
                        || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true);
      
      // רק אדמינים יכולים לעדכן
      allow update: if request.auth != null 
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
  }
}
```

3. לחץ על **Publish**

---

## 🧪 בדיקה שהכל עובד

### בדיקה 1: צד לקוח
1. התחבר כלקוח (לא אדמין)
2. לך ל"הזמנת תור"
3. בחר ספר, טיפול, ותאריך
4. גלול מטה - **אמור לראות מלבן אדום**: "לא מצאת תור לזמן שלך?"
5. לחץ על המלבן
6. בחר טווח שעות (למשל 14:00 - 16:00)
7. לחץ "הירשם לרשימת המתנה"
8. אמורה להופיע הודעת אישור

**אם זה לא עובד:** בדוק את הקונסול לשגיאות אינדקס

### בדיקה 2: צד אדמין
1. התחבר כאדמין
2. לך ל"ניהול אדמין"
3. גלול מטה - **אמור לראות כרטיס**: "רשימת המתנה" (אדום)
4. לחץ עליו
5. אמור לראות לוח של 7 ימים
6. אם הלקוח נרשם בבדיקה 1, הוא אמור להופיע פה!

**אם זה שולח אותך לעמוד הבית:**
- ודא שאתה מחובר כאדמין
- רענן את האפליקציה (Ctrl+C ואז `npx expo start -c`)
- בדוק בקונסול אם יש שגיאות

### בדיקה 3: הודעות אוטומטיות
1. צור תור ללקוח (כאדמין)
2. הלקוח נרשם לרשימת המתנה לאותו יום
3. בטל את התור (כאדמין)
4. **הלקוח אמור לקבל הודעת פוש**: "הזדרז! תור התפנה!"

### בדיקה 4: מחיקה אוטומטית
1. בדוק את הקונסול כשהאפליקציה נטענת
2. אמור לראות: `✅ Old waitlist entries cleaned up automatically`
3. רשומות מיום אתמול ומקודם אמורות להימחק אוטומטית

---

## 🐛 פתרון בעיות נפוצות

### בעיה: "שולח אותי לעמוד הבית כשלוחץ על רשימת המתנה"

**פתרונות:**
1. **רענן את האפליקציה:**
   ```bash
   # עצור את השרת (Ctrl+C)
   npx expo start -c
   ```

2. **ודא שאתה אדמין:**
   - בדוק בקונסול אם יש הודעה: "אין לך הרשאות מנהל"
   - אם כן, הרץ סקריפט להפיכתך לאדמין

3. **בדוק שהמסך קיים:**
   - ודא שהקובץ `app/screens/AdminWaitlistScreen.tsx` קיים
   - ודא שהוא מיובא ב-`app/navigation/AppNavigator.tsx`

### בעיה: "Missing index" או "Requires an index"

**פתרון:**
- לחץ על הקישור בשגיאה
- או צור את האינדקסים ידנית (ראה שלב 2)
- חכה 2-5 דקות לבנייה

### בעיה: "Permission denied"

**פתרון:**
- הוסף את חוקי האבטחה (ראה שלב 3)
- ודא שהמשתמש מחובר

### בעיה: "לא מקבל הודעות פוש"

**פתרונות:**
1. ודא שהלקוח נתן הרשאות להודעות
2. בדוק שיש `pushToken` במסד הנתונים עבור המשתמש
3. בדוק את הקונסול לשגיאות שליחת הודעות

---

## 📝 סיכום - מה צריך לעשות

- [ ] רענן את האפליקציה: `npx expo start -c`
- [ ] צור 2 אינדקסים ב-Firestore
- [ ] חכה 2-5 דקות לבנייה
- [ ] הוסף חוקי אבטחה לקולקציה `waitlist`
- [ ] בדוק שהכל עובד (4 בדיקות למעלה)

**אחרי זה הכל אמור לעבוד מושלם! 🎉**

---

## 💡 טיפים

1. **ניפוי באגים:**
   - תמיד בדוק את הקונסול לשגיאות
   - Firebase נותנת קישורים ישירים ליצירת אינדקסים - השתמש בהם!

2. **ביצועים:**
   - האינדקסים משפרים מהירות שאילתות פי 100
   - מחיקה אוטומטית שומרת על בסיס נתונים נקי

3. **תחזוקה:**
   - בדוק את מסך רשימת המתנה מדי פעם
   - שלח הודעות ללקוחות כשיש שינויים

---

אם יש בעיות - תמיד אפשר לבדוק את הקונסול ולחפש שגיאות! 🔍

